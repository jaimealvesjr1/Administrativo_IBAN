{% extends "base/layout.html" %}
{% from 'base/components/forms.html' import field %}
{% from 'base/components/buttons.html' import submit, danger %}

{% block title %}{% if pg %}Editar Pequeno Grupo{% else %}Criar Pequeno Grupo{% endif %} · IBAN{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="text-center mb-4">
        <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo IBAN" style="max-height: 150px;">
    </div>
    <div class="card shadow-lg p-4 rounded-4 mx-auto" style="max-width: 500px;">
        <h2 class="text-center">
            <strong>{% if pg %}Editar PG: {{ pg.nome }}{% else %}Novo PG{% endif %}</strong>
        </h2>
        <form method="POST" enctype="multipart/form-data">
            {{ form.hidden_tag() }}
            {% set is_readonly = 'readonly' if not current_user.has_permission('admin') else '' %}
            {% if not pg %}
            {% endif %}
            <div class="mb-3">
                {{ form.facilitador.label (class="form-label") }}
                {{ form.facilitador (class="form-select", id="facilitador_select") }}
            </div>
            <div class="mb-3">
                {{ form.nome.label(class="form-label") }}
                {% if pg %}
                    {{ form.nome(class="form-control", **{'readonly': is_readonly} if is_readonly else {}) }}
                {% else %}
                    {{ form.nome(class="form-control") }}
                {% endif %}
            </div>
            <div class="mb-3">
                {{ form.anfitriao.label (class="form-label") }}
                {{ form.anfitriao (class="form-select") }}
            </div>

            <div class="mb-3">
                {{ form.setor.label (class="form-label") }}
                {{ form.setor (class="form-select") }}
            </div>
            <div class="mb-3">
                <div class="row mb-4">
                    <div class="col-md-6">
                        {{ form.dia_reuniao.label (class="form-label") }}
                        {{ form.dia_reuniao (class="form-select") }}
                    </div>
                    <div class="col-md-6">
                        {{ form.horario_reuniao.label (class="form-label") }}
                        {{ form.horario_reuniao (class="form-control") }}
                    </div>
                </div>
            </div>
            {{ submit('Salvar Alterações' if pg else 'Criar Pequeno Grupo') }}
        </form>

        {% set can_close = current_user.has_permission('admin') or is_area_supervisor or is_sector_supervisor %}
        {% if pg and pg.ativo and can_close %}
        <div class="mt-3">
            <form method="POST" action="{{ url_for('grupos.fechar_pg', pg_id=pg.id) }}" 
                    onsubmit="return confirm('ATENÇÃO: Fechar o PG irá congelar todas as informações. Tem certeza?');">
                {{ form.hidden_tag() }}
                <button type="submit" class="btn btn-danger w-100"><strong>Fechar PG</strong></button>
            </form>
        </div>
        {% endif %}

        <div class="text-end mt-3">
            <a href="{{ url_for('grupos.listar_pgs') }}" class="btn btn-outline-secondary">⬅ Voltar</a>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const facilitadorSelect = document.getElementById('facilitador_select');
        const nomeInput = document.getElementsByName('nome')[0];
        
        function suggestName() {
            const selectedFacilitador = facilitadorSelect.value;
            if (selectedFacilitador && selectedFacilitador != 0) {
                window.location.href = "{{ url_for('grupos.criar_pg') }}?facilitador=" + selectedFacilitador;
            }
        }
        
        {% if not pg %}
            facilitadorSelect.addEventListener('change', suggestName);
            
            {% if nome_sugerido_base %}
                if (!nomeInput.value) {
                    nomeInput.value = "{{ nome_sugerido_base }}";
                }
            {% endif %}
        {% endif %}
    });
</script>
{% endblock %}
