{% extends "base/layout.html" %}
{% from 'base/components/forms.html' import field %}
{% from 'base/components/buttons.html' import submit %}

{% block title %}{% if pg %}Editar PG{% else %}Novo PG{% endif %} · IBAN{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg border-0 rounded-3">
                <div class="card-header bg-primary text-white py-3 d-flex justify-content-between align-items-center">
                    <h4 class="mb-0 fw-bold">
                        <i class="bi bi-people-fill me-2"></i>
                        {% if pg %}Editar Pequeno Grupo{% else %}Criar Pequeno Grupo{% endif %}
                    </h4>
                    <a href="{{ url_for('grupos.listar_pgs') }}" class="btn btn-sm btn-outline-light">
                        <i class="bi bi-x-lg"></i> Cancelar
                    </a>
                </div>

                <div class="card-body p-4">
                    <form method="POST">
                        {{ form.hidden_tag() }}
                        {% set is_readonly = 'readonly' if (pg and not current_user.has_permission('admin')) else '' %}

                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-muted text-uppercase small fw-bold border-bottom pb-2 mb-3">Identificação</h6>
                            </div>
                            
                            <div class="col-md-12 mb-3">
                                {{ form.nome.label(class="form-label fw-bold") }}
                                {% if pg and is_readonly %}
                                    {{ form.nome(class="form-control form-control-lg bg-light", readonly=True) }}
                                {% else %}
                                    {{ form.nome(class="form-control form-control-lg", placeholder="Ex: PG Vida Nova") }}
                                {% endif %}
                            </div>

                            <div class="col-md-4 mb-3">
                                {{ form.setor.label(class="form-label fw-bold") }}
                                {{ form.setor(class="form-select", id="setor_select2") }}
                            </div>

                            <div class="col-md-4 mb-3">
                                {{ form.dia_reuniao.label(class="form-label fw-bold") }}
                                {{ form.dia_reuniao(class="form-select", id="dia_select2") }}
                            </div>

                            <div class="col-md-4 mb-3">
                                {{ form.horario_reuniao.label(class="form-label fw-bold") }}
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-clock"></i></span>
                                    {{ form.horario_reuniao(class="form-control", placeholder="19:30", id="horario_input") }}
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-muted text-uppercase small fw-bold border-bottom pb-2 mb-3">Liderança</h6>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                {{ form.facilitador.label(class="form-label fw-bold") }}
                                {{ form.facilitador(class="form-select", id="facilitador_select2") }}
                                {% if form.facilitador.errors %}
                                    <div class="text-danger small">{{ form.facilitador.errors[0] }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-6 mb-3">
                                {{ form.anfitriao.label(class="form-label fw-bold") }}
                                {{ form.anfitriao(class="form-select", id="anfitriao_select2") }}
                                {% if form.anfitriao.errors %}
                                    <div class="text-danger small">{{ form.anfitriao.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="d-grid gap-2 pt-2">
                            {{ submit('Salvar Dados do PG', class="btn btn-primary btn-lg") }}
                            
                            {% set can_close = current_user.has_permission('admin') or current_user.has_permission('secretaria') or is_area_supervisor or is_sector_supervisor %}
                            {% if pg and pg.ativo and can_close %}
                                <button type="button" class="btn btn-outline-danger mt-2" data-bs-toggle="modal" data-bs-target="#modalFecharPG">
                                    <i class="bi bi-archive-fill me-2"></i>Fechar este PG
                                </button>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% if pg and pg.ativo %}
<div class="modal fade" id="modalFecharPG" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Fechar Pequeno Grupo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>ATENÇÃO: Fechar o PG irá congelar as informações e torná-lo inativo. Esta ação geralmente é feita quando o PG encerra suas atividades sem se multiplicar. Tem certeza?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form method="POST" action="{{ url_for('grupos.fechar_pg', pg_id=pg.id) }}">
                    <button type="submit" class="btn btn-danger">Confirmar Fechamento</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Configuração do Select2
        const select2Config = {
            theme: 'bootstrap-5',
            width: '100%'
        };

        $('#facilitador_select2').select2({ ...select2Config, placeholder: 'Selecione o Facilitador' });
        $('#anfitriao_select2').select2({ ...select2Config, placeholder: 'Selecione o Anfitrião' });
        $('#setor_select2').select2({ ...select2Config, placeholder: 'Selecione o Setor' });
        $('#dia_select2').select2({ ...select2Config, minimumResultsForSearch: Infinity });

        $('#horario_input').mask('00:00');

        // Lógica de sugestão de nome (se for criação)
        {% if not pg %}
            $('#facilitador_select2').on('change', function() {
                const selectedVal = $(this).val();
                if (selectedVal && selectedVal != 0) {
                    // Redireciona para pegar o nome (mantendo o comportamento original do seu código)
                    window.location.href = "{{ url_for('grupos.criar_pg') }}?facilitador=" + selectedVal;
                }
            });
        {% endif %}
    });
</script>
{% endblock %}
