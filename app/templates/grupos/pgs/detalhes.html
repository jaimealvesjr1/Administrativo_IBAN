{% set show_navbar = true %}
{% extends "base/layout.html" %}
{% from 'base/components/modals.html' import confirm_modal %}
{% from 'base/components/jornada_timeline.html' import render_jornada_timeline %}
{% from 'macros/filters.html' import render_meta_card %}

{% block title %}PG {{ pg.nome }} · IBAN{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><strong>PG {{ pg.nome }} > <a href="{{ url_for('grupos.detalhes_setor', setor_id=pg.setor.id) }}">Setor {{ pg.setor.nome if pg.setor else 'N/A' }}</a> > <a href="{{ url_for('grupos.detalhes_area', area_id=pg.setor.area.id) }}">Área {{ pg.setor.area.nome if pg.setor and pg.setor.area else 'N/A' }}</a></strong></h2>
        <div class="btn-group">
            <a href="{{ url_for('grupos.editar_pg', pg_id=pg.id) }}" class="btn btn-primary">Editar Cadastro</a>
            <a href="{{ url_for('grupos.listar_pgs') }}" class="btn btn-outline-secondary">Voltar à Lista</a>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0 text-center">Metas do PG</h5>
                </div>
                <div class="card-body">
                    <div class="row row-cols-1 row-cols-md-5 g-2">
                        {{ render_meta_card('Facilitadores em Treinamento', pg.meta_facilitadores_treinamento, pg.num_facilitadores_treinamento_atuais, 'bi-person-badge') }} 
                        {{ render_meta_card('Anfitriões em Treinamento', pg.meta_anfitrioes_treinamento, pg.num_anfitrioes_treinamento_atuais, 'bi-house-heart') }} 
                        {{ render_meta_card('Participantes frequentes no CTM', pg.meta_ctm_participantes, pg.num_ctm_participantes_atuais, 'bi-book') }} 
                        {{ render_meta_card('Participantes no Encontro', pg.meta_encontro_deus_participantes, pg.num_encontro_deus_participantes_atuais, 'bi-fire') }} 
                        {{ render_meta_card('Batizados/Aclamados', pg.meta_batizados_aclamados, pg.num_batizados_aclamados_atuais, 'bi-calendar-heart') }} 
                    </div>
                </div>
            </div>
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Participantes</h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Indicadores</th>
                                <th>Cargo no PG</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set lista_participantes = pg.participantes.all() %}
                            {% if pg.anfitriao and pg.anfitriao.id != pg.facilitador.id %}
                                {% set lista_participantes = pg.participantes.all() + [pg.anfitriao] %}
                            {% endif %}

                            {% for participante in lista_participantes %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('membresia.perfil', id=participante.id) }}">{{ participante.nome_completo }}</a>
                                </td>
                                <td>
                                    <form action="{{ url_for('grupos.atualizar_indicadores', pg_id=pg.id, membro_id=participante.id) }}" method="POST" class="d-flex flex-wrap gap-2">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="participou_encontro_deus_{{ participante.id }}" name="participou_encontro_deus" value="true" {% if participante.participou_encontro_deus %}checked{% endif %}>
                                            <label class="form-check-label" for="participou_encontro_deus_{{ participante.id }}">Encontro</label>
                                        </div>
                                        {% if participante.status == 'Não-Membro' %}
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="checkbox" id="batizado_aclamado_{{ participante.id }}" name="batizado_aclamado" value="true" {% if participante.batizado_aclamado %}checked{% endif %}>
                                                <label class="form-check-label" for="batizado_aclamado_{{ participante.id }}">Batismo/Aclamação</label>
                                            </div>
                                        {% endif %}
                                    </form>
                                </td>
                                <td>
                                    <form action="{{ url_for('grupos.atualizar_indicadores', pg_id=pg.id, membro_id=participante.id) }}" method="POST" class="d-flex flex-wrap gap-2">
                                        <div class="form-group flex-grow-1">
                                            <select name="status_treinamento_pg_{{ participante.id }}" class="form-select form-select-sm">
                                                <option value="Nenhum" {% if participante.status_treinamento_pg == 'Nenhum' %}selected{% endif %}>Nenhum</option>
                                                <option value="Secretário do PG" {% if participante.status_treinamento_pg == 'Secretário do PG' %}selected{% endif %}>Secretário do PG</option>
                                                <option value="Facilitador em Treinamento" {% if participante.status_treinamento_pg == 'Facilitador em Treinamento' %}selected{% endif %}>Facilitador em Treinamento</option>
                                                <option value="Anfitrião em Treinamento" {% if participante.status_treinamento_pg == 'Anfitrião em Treinamento' %}selected{% endif %} {% if participante.id == pg.anfitriao.id %}disabled{% endif %}>Anfitrião em Treinamento</option>
                                            </select>
                                        </div>
                                        <button type="submit" class="btn btn-sm btn-success">Atualizar</button>
                                    </form>
                                </td>
                                <td>
                                    <form action="{{ url_for('grupos.remover_participante', pg_id=pg.id, membro_id=participante.id) }}" method="POST" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-danger text-white" onclick="return confirm('Tem certeza que deseja remover {{ participante.nome_completo }} deste PG? Os indicadores serão resetados.');">Remover</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <h6 class="card-subtitle mb-2">Adicionar novo participante:</h6>
                    <form action="{{ url_for('grupos.adicionar_participante', pg_id=pg.id) }}" method="post" class="mb-3">
                        <div class="input-group">
                            <select class="form-select" name="membro_id" id="membro_select2" required>
                                <option></option>
                            </select>
                            <button class="btn btn-primary" type="submit">Adicionar</button>
                        </div>
                        <small class="form-text text-muted mt-2 d-block">
                            Não encontrou o participante?
                            <a href="{{ url_for('membresia.cadastro_nao_membro') }}">Clique aqui para cadastrar</a>.
                        </small>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Dados do PG</h5>
                </div>
                <div class="card-body">
                    <p class="card-text"><strong>Facilitador:</strong> {{ pg.facilitador.nome_completo if pg.facilitador else 'N/A' }}</p>
                    <p class="card-text"><strong>Anfitrião:</strong> {{ pg.anfitriao.nome_completo if pg.anfitriao else 'N/A' }}</p>
                    <p class="card-text"><strong>Dia da Reunião:</strong> {{ pg.dia_reuniao }}</p>
                    <p class="card-text"><strong>Horário da Reunião:</strong> {{ pg.horario_reuniao }}</p>
                    <p class="card-text"><strong>Data de Multiplicação:</strong> {{ pg.data_multiplicacao|strftime('%d/%m/%Y') if pg.data_multiplicacao else 'N/A' }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            {% if ctm_dados_alunos %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Alunos no CTM</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm">
                            <thead>
                                <tr>
                                    <th scope="col" class="text-nowrap">Aluno</th>
                                    <th scope="col" class="text-nowrap">Classe e Turma</th>
                                    <th scope="col" class="text-nowrap text-center">Presenças</th>
                                    <th scope="col" class="text-nowrap text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for aluno_ctm in ctm_dados_alunos %}
                                <tr>
                                    <td class="text-nowrap"><a href="{{ url_for('membresia.perfil', id=aluno_ctm.membro.id) }}">{{ aluno_ctm.membro.nome_completo }}</a></td>
                                    <td>{{ aluno_ctm.classe.nome }} - {{ aluno_ctm.turma.nome }}</td>
                                    <td class="text-center">
                                        {{ aluno_ctm.total_presencas }} / {{ aluno_ctm.total_aulas }}
                                    </td>
                                    <td class="text-center">
                                        {% if aluno_ctm.status_conclusao == 'Aprovado' %}
                                            <span class="badge bg-success">Aprovado</span>
                                        {% elif aluno_ctm.status_conclusao == 'Reprovado' %}
                                            <span class="badge bg-danger">Reprovado</span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">Em Andamento</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
            {{ render_jornada_timeline(jornada_eventos) }}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        $('#membro_select2').select2({
            placeholder: "Clique para buscar ou digite o nome do participante",
            allowClear: true,
            theme: 'bootstrap-5',
            ajax: {
                url: "{{ url_for('grupos.buscar_membros_pgs') }}",
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        term: params.term
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.items
                    };
                },
                cache: true
            }
        });
    });
</script>
{% endblock %}
