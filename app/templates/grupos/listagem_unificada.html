{% set show_navbar = true %}
{% extends "base/layout.html" %}
{% from 'base/components/modals.html' import confirm_modal %}

{% block title %}Listagem de Grupos · IBAN{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2><strong>
        {% if current_user.membro %}
        Grupos Liderados
        {% elif current_user.has_permission('admin') %}
        Painel Administrativo - Grupos
        {% endif %}
    </strong></h2>
    <ul class="nav nav-tabs" id="groupTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if tipo_selecionado == 'pgs' %}active{% endif %}" id="pgs-tab" data-bs-toggle="tab" data-bs-target="#pgs-content" type="button" role="tab" aria-controls="pgs-content" aria-selected="true"><strong>Pequenos Grupos</strong></button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if tipo_selecionado == 'setores' %}active{% endif %}" id="setores-tab" data-bs-toggle="tab" data-bs-target="#setores-content" type="button" role="tab" aria-controls="setores-content" aria-selected="false"><strong>Setores</strong></button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if tipo_selecionado == 'areas' %}active{% endif %}" id="areas-tab" data-bs-toggle="tab" data-bs-target="#areas-content" type="button" role="tab" aria-controls="areas-content" aria-selected="false"><strong>Áreas</strong></button>
        </li>
    </ul>
    <div class="tab-content" id="groupTabsContent">
        <div class="tab-pane fade {% if tipo_selecionado == 'pgs' %}show active{% endif %}" id="pgs-content" role="tabpanel" aria-labelledby="pgs-tab">
            <div class="d-flex justify-content-between align-items-center mt-3">
                <h4 class="mb-0"><strong>Pequenos Grupos</strong></h4>
                <a href="{{ url_for('grupos.criar_pg') }}" class="btn btn-primary">Criar Novo PG</a>
            </div>
            {% if pgs %}
                <div class="table-responsive mt-3">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th scope="col">Nome do PG</th>
                                <th scope="col">Facilitador</th>
                                <th scope="col">Anfitrião</th>
                                <th scope="col">Setor</th>
                                <th scope="col">Dia/Hora</th>
                                <th scope="col">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pg in pgs %}
                            <tr>
                                <td><a href="{{ url_for('grupos.detalhes_pg', pg_id=pg.id) }}">{{ pg.nome }}</a></td>
                                <td>{{ pg.facilitador.nome_completo if pg.facilitador else 'N/A' }}</td>
                                <td>{{ pg.anfitriao.nome_completo if pg.anfitriao else 'N/A' }}</td>
                                <td>{{ pg.setor.nome if pg.setor else 'N/A' }}</td>
                                <td>{{ pg.dia_reuniao }} às {{ pg.horario_reuniao }}</td>
                                <td>
                                    <a href="{{ url_for('grupos.editar_pg', pg_id=pg.id) }}" class="btn btn-sm btn-info">Editar</a>
                                    <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#confirmDeletePGModal{{ pg.id }}">Deletar</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="mt-3">Nenhum Pequeno Grupo.</p>
            {% endif %}
        </div>

        {# --- TAB CONTENT PARA SETORES --- #}
        <div class="tab-pane fade {% if tipo_selecionado == 'setores' %}show active{% endif %}" id="setores-content" role="tabpanel" aria-labelledby="setores-tab">
            <div class="d-flex justify-content-between align-items-center mt-3">
                <h4 class="mb-0"><strong>Setores</strong></h4>
                <a href="{{ url_for('grupos.criar_setor') }}" class="btn btn-primary">Criar Novo Setor</a>
            </div>
            {% if setores %}
                <div class="table-responsive mt-3">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th scope="col">Nome do Setor</th>
                                <th scope="col">Supervisor</th>
                                <th scope="col">Área</th>
                                <th scope="col">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for setor in setores %}
                            <tr>
                                <td><a href="{{ url_for('grupos.detalhes_setor', setor_id=setor.id) }}">{{ setor.nome }}</a></td>
                                <td>{{ setor.supervisor.nome_completo if setor.supervisor else 'N/A' }}</td>
                                <td>{{ setor.area.nome if setor.area else 'N/A' }}</td>
                                <td>
                                    <a href="{{ url_for('grupos.editar_setor', setor_id=setor.id) }}" class="btn btn-sm btn-info">Editar</a>
                                    <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteSetorModal{{ setor.id }}">Deletar</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="mt-3">Nenhum Setor.</p>
            {% endif %}
        </div>

        {# --- TAB CONTENT PARA ÁREAS --- #}
        <div class="tab-pane fade {% if tipo_selecionado == 'areas' %}show active{% endif %}" id="areas-content" role="tabpanel" aria-labelledby="areas-tab">
            <div class="d-flex justify-content-between align-items-center mt-3">
                <h4 class="mb-0"><strong>Áreas</strong></h4>
                <a href="{{ url_for('grupos.criar_area') }}" class="btn btn-primary">Criar Nova Área</a>
            </div>
            {% if areas %}
                <div class="table-responsive mt-3">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th scope="col">Nome da Área</th>
                                <th scope="col">Coordenador</th>
                                <th scope="col">Data de Criação</th>
                                <th scope="col">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for area in areas %}
                            <tr>
                                <td><a href="{{ url_for('grupos.detalhes_area', area_id=area.id) }}">{{ area.nome }}</a></td>
                                <td>{{ area.coordenador.nome_completo if area.coordenador else 'N/A' }}</td>
                                <td>{{ area.data_criacao|strftime('%d/%m/%Y %H:%M') }}</td>
                                <td>
                                    <a href="{{ url_for('grupos.editar_area', area_id=area.id) }}" class="btn btn-sm btn-info">Editar</a>
                                    <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteAreaModal{{ area.id }}">Deletar</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="mt-3">Nenhuma Área.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% for pg in pgs %}
    {{ confirm_modal(
        id='confirmDeletePGModal' ~ pg.id,
        title='Confirmar Exclusão de Pequeno Grupo',
        body='Tem certeza que deseja deletar o Pequeno Grupo "' ~ pg.nome ~ '"? Atenção: Isso desvinculará todos os participantes e não pode ser desfeito.',
        action_url=url_for('grupos.deletar_pg', pg_id=pg.id)
    ) }}
{% endfor %}

{% for setor in setores %}
    {{ confirm_modal(
        id='confirmDeleteSetorModal' ~ setor.id,
        title='Confirmar Exclusão de Setor',
        body='Tem certeza que deseja deletar o Setor "' ~ setor.nome ~ '"? Atenção: Isso não pode ser desfeito e só é possível se não houver Pequenos Grupos vinculados.',
        action_url=url_for('grupos.deletar_setor', setor_id=setor.id)
    ) }}
{% endfor %}

{% for area in areas %}
    {{ confirm_modal(
        id='confirmDeleteAreaModal' ~ area.id,
        title='Confirmar Exclusão de Área',
        body='Tem certeza que deseja deletar a Área "' ~ area.nome ~ '"? Atenção: Isso não pode ser desfeito e só é possível se não houver Setores vinculados.',
        action_url=url_for('grupos.deletar_area', area_id=area.id)
    ) }}
{% endfor %}

{% block scripts %}
{{ super() }}
<script>
    $(document).ready(function() {
        var tipoSelecionado = "{{ tipo_selecionado }}";
        if (tipoSelecionado) {
            $('#' + tipoSelecionado + '-tab').tab('show');
        }
    });
</script>
{% endblock %}
