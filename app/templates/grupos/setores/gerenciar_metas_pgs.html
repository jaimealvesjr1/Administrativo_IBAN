{% extends "base/layout.html" %}
{% from 'base/components/forms.html' import field %}
{% from 'base/components/buttons.html' import submit %}

{% block title %}Gerenciar Metas · IBAN{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2><strong>Metas dos PGs do Setor {{ setor.nome }}</strong></h2>
    <p class="text-muted text-center">Defina as metas individuais para cada Pequeno Grupo.</p>
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-warning text-white">
            <h5 class="mb-0">Metas do Setor</h5>
        </div>
        <div class="card-body">
            <div class="row row-cols-1 row-cols-md-6 g-2 justify-content-between">
                {% macro render_meta_card(label, meta, atual, icon_class) %}
                <div class="col">
                    <div class="card h-100 border-{% if atual >= meta %}success{% else %}danger{% endif %}">
                        <div class="card-body p-2 d-flex align-items-center">
                            <p class="mb-0 me-2 ms-2"><strong>{{ meta }}</strong></p>
                            <small class="text-muted d-block">{{ label }}</small>
                        </div>
                    </div>
                </div>
                {% endmacro %}

                {{ render_meta_card('Facilitadores em Treinamento', setor.meta_facilitadores_treinamento, setor.num_facilitadores_treinamento_atuais_agregado) }}
                {{ render_meta_card('Anfitriões em Treinamento', setor.meta_anfitrioes_treinamento, setor.num_anfitrioes_treinamento_atuais_agregado) }}
                {{ render_meta_card('Participantes frequentes no CTM', setor.meta_ctm_participantes, setor.num_ctm_participantes_atuais_agregado) }}
                {{ render_meta_card('Participantes no Encontro', setor.meta_encontro_deus_participantes, setor.num_encontro_deus_participantes_atuais_agregado) }}
                {{ render_meta_card('Batizados/ Aclamados', setor.meta_batizados_aclamados, setor.num_batizados_aclamados_atuais_agregado) }}
                {{ render_meta_card('Multiplicações de PG', setor.meta_multiplicacoes_pg, setor.num_multiplicacoes_pg_atuais_agregado, 'bi-arrow-repeat') }}
            </div>
        </div>
    </div>
    <form method="POST">
        {% for pg in pgs %}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">PG {{ pg.nome }}</h5>
                <small>Facilitador {{ pg.facilitador.nome_completo }}</small>
            </div>
            <div class="card-body">
                {{ forms[pg.id].hidden_tag() }}
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="meta_fac_treinamento_{{ pg.id }}" class="form-label">{{ forms[pg.id].meta_facilitadores_treinamento.label.text }}</label>
                        <input type="range" class="form-range" id="meta_fac_treinamento_{{ pg.id }}"
                               name="{{ forms[pg.id].meta_facilitadores_treinamento.name }}" 
                               min="0" max="{{ setor.meta_facilitadores_treinamento if setor.meta_facilitadores_treinamento > 0 else 20 }}" 
                               value="{{ forms[pg.id].meta_facilitadores_treinamento.data }}"
                               oninput="this.nextElementSibling.value = this.value">
                        <output class="float-end mt-2">{{ forms[pg.id].meta_facilitadores_treinamento.data }}</output>
                    </div>
                    <div class="col-md-6">
                        <label for="meta_anf_treinamento_{{ pg.id }}" class="form-label">{{ forms[pg.id].meta_anfitrioes_treinamento.label.text }}</label>
                        <input type="range" class="form-range" id="meta_anf_treinamento_{{ pg.id }}" 
                               name="{{ forms[pg.id].meta_anfitrioes_treinamento.name }}" 
                               min="0" max="{{ setor.meta_anfitrioes_treinamento if setor.meta_anfitrioes_treinamento > 0 else 20 }}" 
                               value="{{ forms[pg.id].meta_anfitrioes_treinamento.data }}"
                               oninput="this.nextElementSibling.value = this.value">
                        <output class="float-end mt-2">{{ forms[pg.id].meta_anfitrioes_treinamento.data }}</output>
                    </div>
                    <div class="col-md-4">
                        <label for="meta_ctm_{{ pg.id }}" class="form-label">{{ forms[pg.id].meta_ctm_participantes.label.text }}</label>
                        <input type="range" class="form-range" id="meta_ctm_{{ pg.id }}" 
                               name="{{ forms[pg.id].meta_ctm_participantes.name }}" 
                               min="0" max="{{ setor.meta_ctm_participantes if setor.meta_ctm_participantes > 0 else 20 }}" 
                               value="{{ forms[pg.id].meta_ctm_participantes.data }}"
                               oninput="this.nextElementSibling.value = this.value">
                        <output class="float-end mt-2">{{ forms[pg.id].meta_ctm_participantes.data }}</output>
                    </div>
                    <div class="col-md-4">
                        <label for="meta_encontro_{{ pg.id }}" class="form-label">{{ forms[pg.id].meta_encontro_deus_participantes.label.text }}</label>
                        <input type="range" class="form-range" id="meta_encontro_{{ pg.id }}" 
                               name="{{ forms[pg.id].meta_encontro_deus_participantes.name }}" 
                               min="0" max="{{ setor.meta_encontro_deus_participantes if setor.meta_encontro_deus_participantes > 0 else 20 }}" 
                               value="{{ forms[pg.id].meta_encontro_deus_participantes.data }}"
                               oninput="this.nextElementSibling.value = this.value">
                        <output class="float-end mt-2">{{ forms[pg.id].meta_encontro_deus_participantes.data }}</output>
                    </div>
                    <div class="col-md-4">
                        <label for="meta_batizados_{{ pg.id }}" class="form-label">{{ forms[pg.id].meta_batizados_aclamados.label.text }}</label>
                        <input type="range" class="form-range" id="meta_batizados_{{ pg.id }}" 
                               name="{{ forms[pg.id].meta_batizados_aclamados.name }}" 
                               min="0" max="{{ setor.meta_batizados_aclamados if setor.meta_batizados_aclamados > 0 else 20 }}" 
                               value="{{ forms[pg.id].meta_batizados_aclamados.data }}"
                               oninput="this.nextElementSibling.value = this.value">
                        <output class="float-end mt-2">{{ forms[pg.id].meta_batizados_aclamados.data }}</output>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        {{ submit('Salvar Distribuição') }}
        <div class="text-end mt-3">
            <a href="{{ url_for('grupos.detalhes_setor', setor_id=setor.id) }}" class="btn btn-outline-secondary">⬅ Voltar</a>
        </div>
    </form>
</div>
{% endblock %}
