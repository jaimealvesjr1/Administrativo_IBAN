{% set show_navbar = true %}
{% extends "base/layout.html" %}
{% from 'base/components/modals.html' import confirm_modal %}
{% from 'base/components/jornada_timeline.html' import render_jornada_timeline %}
{% from 'macros/filters.html' import render_meta_card %}

{% block title %}Setor {{ setor.nome }} · IBAN{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><strong>Setor {{ setor.nome }} > <a href="{{ url_for('grupos.detalhes_area', area_id=setor.area.id) }}">Área {{ setor.area.nome if setor.area else 'N/A' }}</a></strong></h2>
        <div class="btn-group">
            <a href="{{ url_for('grupos.listar_setores') }}" class="btn btn-outline-secondary">Voltar à Lista</a>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12 text-center ">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">Metas do Setor</h5>
                </div>
                <div class="card-body">
                    <div class="row row-cols-1 row-cols-md-6 g-2">
                        {{ render_meta_card('Facilitadores em Treinamento', setor.meta_facilitadores_treinamento, setor.num_facilitadores_treinamento_atuais_agregado, 'bi-person-badge') }}
                        {{ render_meta_card('Anfitriões em Treinamento', setor.meta_anfitrioes_treinamento, setor.num_anfitrioes_treinamento_atuais_agregado, 'bi-house-heart') }}
                        {{ render_meta_card('Participantes frequentes no CTM', setor.meta_ctm_participantes, setor.num_ctm_participantes_atuais_agregado, 'bi-book') }}
                        {{ render_meta_card('Participantes no Encontro', setor.meta_encontro_deus_participantes, setor.num_encontro_deus_participantes_atuais_agregado, 'bi-fire') }}
                        {{ render_meta_card('Batizados/ Aclamados', setor.meta_batizados_aclamados, setor.num_batizados_aclamados_atuais_agregado, 'bi-calendar-heart') }}
                        {{ render_meta_card('Multiplicações de PG', setor.meta_multiplicacoes_pg, setor.num_multiplicacoes_pg_atuais_agregado, 'bi-x') }}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Dados do Setor</h5>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        <strong>Supervisores:</strong>
                        {% for supervisor in setor.supervisores %}
                            <span class="badge bg-primary me-1">{{ supervisor.nome_completo }}</span>
                        {% else %}
                            Nenhum supervisor atribuído.
                        {% endfor %}
                    </p>
                </div>
            </div>
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">PGs no Setor</h5>
                </div>
                <div class="card-body">
                    {% if setor.pequenos_grupos.count() > 0 %}
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th scope="col">Nome</th>
                                    <th scope="col">Dia/Hora</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pg in setor.pequenos_grupos %}
                                <tr>
                                    <td><a href="{{ url_for('grupos.detalhes_pg', pg_id=pg.id) }}">PG {{ pg.nome }}</a></td>
                                    <td>{{ pg.dia_reuniao }} às {{ pg.horario_reuniao }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p>Nenhum Pequeno Grupo vinculado a este Setor ainda.</p>
                    {% endif %}
                    <a href="{{ url_for('grupos.gerenciar_metas_pgs_do_setor', setor_id=setor.id) }}" class="btn btn-secondary">Distribuir Metas</a>
                </div>
            </div>
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Dizimistas nos Últimos 30 Dias</h5>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <canvas id="dizimistasChart" style="max-height: 250px;"></canvas>
                        <p class="mt-2"><strong>Total de Membros no Setor:</strong> {{ setor.num_participantes_totais_agregado }}</p>
                    </div>
                </div>
            </div>     
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Frequência no CTM nos Últimos 30 Dias</h5>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <canvas id="frequenciaCTMChart" style="max-height: 250px;"></canvas>
                        <p class="mt-2"><strong>Total de Participantes:</strong> {{ setor.num_participantes_totais_agregado }}</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            {{ render_jornada_timeline(jornada_eventos) }}
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    $(document).ready(function() {
        var dizimistasData = {{ setor.distribuicao_dizimistas_30d|tojson|safe }};
        var dizimistasLabels = ['Dizimistas', 'Não Dizimistas'];
        var dizimistasCounts = [dizimistasData.dizimistas, dizimistasData.nao_dizimistas];
        
        var ctxDizimistas = document.getElementById('dizimistasChart').getContext('2d');
        new Chart(ctxDizimistas, {
            type: 'pie',
            data: {
                labels: dizimistasLabels,
                datasets: [{
                    data: dizimistasCounts,
                    backgroundColor: ['#42f56c', '#f54242'],
                    hoverBackgroundColor: ['#4bc0c0', '#ff6384']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: false,
                        text: 'Proporção de Dizimistas nos Últimos 30 Dias'
                    }
                }
            }
        });
        var frequenciaCTMData = {{ setor.distribuicao_frequencia_ctm|tojson|safe }};
        var frequenciaCTMLabels = ['Frequentes no CTM', 'Não Frequentes'];
        var frequenciaCTMCounts = [frequenciaCTMData.frequentes_ctm, frequenciaCTMData.nao_frequentes_ctm];
        
        var ctxFrequenciaCTM = document.getElementById('frequenciaCTMChart').getContext('2d');
        new Chart(ctxFrequenciaCTM, {
            type: 'pie',
            data: {
                labels: frequenciaCTMLabels,
                datasets: [{
                    data: frequenciaCTMCounts,
                    backgroundColor: ['#17a2b8', '#dc3545'],
                    hoverBackgroundColor: ['#138496', '#c82333']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: false,
                    }
                }
            }
        });
    });
</script>
{% endblock %}
