{% set show_navbar = true %}
{% extends 'base/layout.html' %}
{% from 'base/components/forms.html' import field %}
{% from 'base/components/buttons.html' import primary %}
{% from 'macros/pagination.html' import render_pagination %}
{% from 'base/components/modals.html' import confirm_modal %}

{% block title %}Diário de Despesas · IBAN{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
            <a href="{{ url_for('financeiro.index') }}" class="btn btn-outline-secondary me-3" title="Voltar ao Painel">
                <i class="bi bi-arrow-left"></i>
            </a>
            <h2 class="mb-0"><strong>Livro de Despesas</strong></h2>
        </div>
        <div>
            <a href="{{ url_for('financeiro.download_despesas_excel', 
                                categoria_filtro=request.args.get('categoria_filtro', ''),
                                centro_custo_filtro=request.args.get('centro_custo_filtro', ''),
                                data_inicial=request.args.get('data_inicial', ''),
                                data_final=request.args.get('data_final', '')) }}"
            class="btn btn-success me-2">
                <i class="bi bi-file-earmark-excel"></i> Exportar Razão (Excel)
            </a>
            {{ primary('+ Novo Lançamento', url_for('financeiro.nova_despesa')) }}
        </div>
    </div>

    <div class="row mb-4 g-3">
        <div class="col-lg-10">
            <div class="card border-0 shadow-sm bg-light h-100">
                <div class="card-body py-3">
                    <form method="GET" action="{{ url_for('financeiro.lancamentos_despesas') }}" class="row g-2 align-items-end">
                        <div class="col-md-3">
                            <label class="small text-muted fw-bold">Grupo de Contas</label>
                            {{ filter_form.categoria_filtro(class="form-select form-select-sm", id="categoria_filtro_select2") }}
                        </div>
                        <div class="col-md-2">
                            <label class="small text-muted fw-bold">Centro de Custo</label>
                            {{ filter_form.centro_custo_filtro(class="form-select form-select-sm", id="centro_custo_filtro_select2") }}
                        </div>
                        <div class="col-md-2">
                             <label class="small text-muted fw-bold">Recorrência</label>
                            {{ filter_form.recorrencia_filtro(class="form-select form-select-sm", id="recorrencia_filtro_select2") }}
                        </div>
                        <div class="col-md-2">
                             <label class="small text-muted fw-bold">De</label>
                            {{ filter_form.data_inicial(class="form-control form-control-sm", type="date", value=filter_form.data_inicial.data.strftime('%Y-%m-%d') if filter_form.data_inicial.data else '') }}
                        </div>
                        <div class="col-md-2">
                             <label class="small text-muted fw-bold">Até</label>
                            {{ filter_form.data_final(class="form-control form-control-sm", type="date", value=filter_form.data_final.data.strftime('%Y-%m-%d') if filter_form.data_final.data else '') }}
                        </div>
                        <div class="col-md-1">
                            {{ filter_form.submit_filter(class="btn btn-primary btn-sm w-100") }}
                        </div>
                    </form>
                    {% if request.args %}
                    <div class="mt-2 text-end">
                         <a href="{{ url_for('financeiro.lancamentos_despesas') }}" class="small text-decoration-none text-secondary"><i class="bi bi-x-circle"></i> Limpar Filtros</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-2">
            <div class="card border-0 shadow-sm bg-danger text-white h-100 d-flex justify-content-center align-items-center text-center p-2">
                <div>
                    <small class="text-uppercase opacity-75 fw-bold" style="font-size: 0.7rem;">Total no Período</small>
                    <div class="h4 fw-bold mb-0 text-nowrap">{{ soma_valores | currency }}</div>
                </div>
            </div>
        </div>
    </div>

    {% if despesas %}
    <div class="table-responsive">
        <table class="table table-hover align-middle" style="border-collapse: separate; border-spacing: 0;">
            <thead class="table-light text-uppercase small text-muted">
                <tr>
                    <th class="border-bottom ps-3">Data</th>
                    <th class="border-bottom">Classificação Contábil</th>
                    <th class="border-bottom">Centro de Custo</th>
                    <th class="border-bottom">Histórico</th>
                    <th class="border-bottom text-end pe-3">Valor (R$)</th>
                    <th class="border-bottom text-center">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for despesa in despesas %}
                <tr class="bg-white border-bottom">
                    <td class="ps-3 text-nowrap font-monospace">{{ despesa.data_lanc.strftime('%d/%m/%Y') }}</td>
                    <td>
                        <div class="d-flex flex-column">
                            <span class="fw-bold text-dark" style="font-size: 0.95rem;">
                                <span class="text-muted font-monospace me-1" style="font-size: 0.85rem;">{{ despesa.item.codigo if despesa.item.codigo else 'S/C' }}</span>
                                {{ despesa.item.nome }}
                            </span>
                            <small class="text-muted" style="font-size: 0.75rem;">
                                <i class="bi bi-folder2-open me-1"></i>{{ despesa.item.categoria.nome }}
                            </small>
                        </div>
                    </td>
                    <td>
                        {% set cor = cores_map.get(despesa.centro_custo, '#6c757d') %}
                        <span class="badge rounded-pill fw-normal text-dark border" style="background-color: #f8f9fa; border-left: 4px solid {{ cor }} !important;">
                            {{ despesa.centro_custo if despesa.centro_custo else 'Geral' }}
                        </span>
                    </td>
                    <td>
                        <span class="text-muted small">{{ despesa.observacoes if despesa.observacoes else '-' }}</span>
                        {% if despesa.recorrencia != 'Isolada' %}
                            <br><span class="badge bg-light text-secondary border mt-1">{{ despesa.recorrencia }}</span>
                        {% endif %}
                    </td>
                    <td class="text-end pe-3 fw-bold text-danger font-monospace">
                        {{ despesa.valor | currency }}
                    </td>
                    <td class="text-center">
                        <div class="btn-group">
                            <a href="{{ url_for('financeiro.editar_despesa', id=despesa.id) }}" class="btn btn-sm btn-link text-decoration-none text-secondary" title="Editar">
                                <i class="bi bi-pencil"></i>
                            </a>
                            {% if current_user.has_permission('admin') %}
                            <button type="button" class="btn btn-sm btn-link text-decoration-none text-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteDespesaModal{{ despesa.id }}" title="Excluir">
                                <i class="bi bi-trash"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-light text-center border py-5">
        <i class="bi bi-journals fs-1 text-muted"></i>
        <p class="mt-3 text-muted">Nenhum lançamento encontrado neste período.</p>
    </div>
    {% endif %}

    {{ render_pagination(pagination, 'financeiro.lancamentos_despesas', 
        categoria_filtro=categoria_filtro, 
        item_filtro=item_filtro,
        recorrencia_filtro=recorrencia_filtro,
        centro_custo_filtro=centro_custo_filtro,
        data_inicial=data_inicial,
        data_final=data_final
    ) }}

    {% for despesa in despesas %}
    {{ confirm_modal(
        id='confirmDeleteDespesaModal' ~ despesa.id,
        title='Estornar Lançamento',
        body='Confirma a exclusão do lançamento contábil referente a ' ~ despesa.item.nome ~ ' no valor de ' ~ (despesa.valor | currency) ~ '?',
        action_url=url_for('financeiro.delete_despesa', id=despesa.id)
    ) }}
    {% endfor %}

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
$(document).ready(function() {
    const select2Config = {
        theme: 'bootstrap-5',
        width: '100%',
        allowClear: true
    };

    if ($('#categoria_filtro_select2').length) {
        $('#categoria_filtro_select2').select2({ ...select2Config, placeholder: "Grupo" });
    }
    if ($('#recorrencia_filtro_select2').length) {
        $('#recorrencia_filtro_select2').select2({ ...select2Config, placeholder: "Tipo", minimumResultsForSearch: Infinity });
    }
    if ($('#centro_custo_filtro_select2').length) {
        $('#centro_custo_filtro_select2').select2({ ...select2Config, placeholder: "Centro de Custo" });
    }
});
</script>
{% endblock %}
