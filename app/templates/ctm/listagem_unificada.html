{% set show_navbar = true %}
{% extends "base/layout.html" %}
{% from 'base/components/modals.html' import confirm_modal %}
{% from 'base/components/buttons.html' import danger, primary %}

{% block title %}Listagem CTM · IBAN{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2><strong>Painel Administrativo - CTM</strong></h2>
    <ul class="nav nav-tabs" id="ctmTabs" role="tablist" data-tipo-selecionado="{{ tipo_selecionado }}">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="classes-tab" data-bs-toggle="tab" data-bs-target="#classes-content" type="button" role="tab" aria-controls="classes-content" aria-selected="true"><strong>Classes</strong></button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="turmas-tab" data-bs-toggle="tab" data-bs-target="#turmas-content" type="button" role="tab" aria-controls="turmas-content" aria-selected="false"><strong>Turmas</strong></button>
        </li>
    </ul>
    
    <div class="tab-content" id="ctmTabsContent">
        <div class="tab-pane fade show active" id="classes-content" role="tabpanel" aria-labelledby="classes-tab">
            <div class="d-flex justify-content-between align-items-center mt-3">
                <h4 class="mb-0"><strong>Classes</strong></h4>
                {{ primary('+ Nova Classe', url_for('ctm.criar_classe')) }}
            </div>
            {% if classes %}
                <div class="table-responsive mt-3">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th scope="col">Nome da Classe</th>
                                <th scope="col">Supervisor</th>
                                <th scope="col">Turmas</th>
                                <th scope="col">Aulas</th>
                                <th scope="col">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for classe, num_aulas in classes %}
                            <tr>
                                <td><a href="{{ url_for('ctm.painel_supervisor_classe', classe_id=classe.id) }}">{{ classe.nome }}</a></td>
                                <td>{{ classe.supervisor.nome_completo if classe.supervisor else 'N/A' }}</td>
                                <td>{{ classe.turmas|length }}</td>
                                <td>{{ num_aulas }}</td>
                                <td>
                                    <a href="{{ url_for('ctm.editar_classe', classe_id=classe.id) }}" class="btn btn-sm btn-info">Editar</a>
                                    <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteClasseModal{{ classe.id }}">Deletar</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="mt-3">Nenhuma Classe cadastrada.</p>
            {% endif %}
        </div>
        
        <div class="tab-pane fade" id="turmas-content" role="tabpanel" aria-labelledby="turmas-tab">
            <div class="d-flex justify-content-between align-items-center mt-3">
                <h4 class="mb-0"><strong>Turmas</strong></h4>
                {{ primary('+ Nova Turma', url_for('ctm.criar_turma')) }}
            </div>
            {% if turmas %}
                <div class="table-responsive mt-3">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th scope="col">Nome da Turma</th>
                                <th scope="col">Facilitador</th>
                                <th scope="col">Classe</th>
                                <th scope="col">Status</th>
                                <th scope="col">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for turma in turmas %}
                            <tr>
                                <td><a href="{{ url_for('ctm.painel_facilitador_turma', turma_id=turma.id) }}">{{ turma.nome }}</a></td>
                                <td>{{ turma.facilitador.nome_completo if turma.facilitador else 'N/A' }}</td>
                                <td>{{ turma.classe.nome if turma.classe else 'N/A' }}</td>
                                <td>{{ 'Ativa' if turma.ativa else 'Inativa' }}</td>
                                <td>
                                    <a href="{{ url_for('ctm.editar_turma', turma_id=turma.id) }}" class="btn btn-sm btn-info">Editar</a>
                                    <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteTurmaModal{{ turma.id }}">Deletar</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="mt-3">Nenhuma Turma cadastrada.</p>
            {% endif %}
        </div>
    </div>
{% for classe, _ in classes %}
{{ confirm_modal(
    id='confirmDeleteClasseModal' ~ classe.id,
    title='Confirmar Exclusão de Classe',
    body='Tem certeza que deseja deletar a Classe ' ~ classe.nome ~ '? Atenção: Isso não pode ser desfeito e só é possível se não houver turmas ou aulas vinculadas.',
    action_url=url_for('ctm.deletar_classe', classe_id=classe.id)
) }}
{% endfor %}
{% for turma in turmas %}
{{ confirm_modal(
    id='confirmDeleteTurmaModal' ~ turma.id,
    title='Confirmar Exclusão de Turma',
    body='Tem certeza que deseja deletar a Turma ' ~ turma.nome ~ '? Atenção: Isso não pode ser desfeito e só é possível se não houver alunos ou aulas realizadas vinculados.',
    action_url=url_for('ctm.deletar_turma', turma_id=turma.id)
) }}
{% endfor %}
</div>
{% endblock %}
