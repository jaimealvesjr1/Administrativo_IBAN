{% set show_navbar = true %}
{% extends "base/layout.html" %}
{% from 'base/components/modals.html' import confirm_modal %}

{% block title %}Painel do Facilitador · IBAN{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><strong>Turma {{ turma.nome }} > <a href="{{ url_for('ctm.painel_supervisor_classe', classe_id=turma.classe.id) }}">Classe {{ turma.classe.nome }}</a></strong></h2>
        <div class="btn-group">
            <a href="{{ url_for('ctm.listar_ctm_unificada') }}" class="btn btn-outline-secondary">⬅ Voltar à Lista</a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0 text-center">Plano de Aulas</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm">
                            <thead>
                                <tr>
                                    <th scope="col">Tema</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for aula_modelo in turma.classe.aulas_modelo %}
                                    {% set aula_realizada = turma.aulas_realizadas | selectattr('aula_modelo_id', '==', aula_modelo.id) | first %}
                                    <tr>
                                        <td>{{ aula_modelo.ordem }} - {{ aula_modelo.tema }}</td>
                                        <td>
                                            {% if aula_realizada %}
                                                <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#infoAulaRealizadaModal{{ aula_realizada.id }}">Detalhes</button>
                                            {% else %}
                                                <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#realizarAulaModal{{ aula_modelo.id }}">Realizar Aula</button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% else %}
                                    <tr>
                                        <td colspan="3">Nenhuma aula modelo cadastrada para esta classe.</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% if turma.ativa %}
                {% set num_aulas_realizadas = aulas_realizadas|length %}
                {% set num_aulas_modelo = turma.classe.aulas_modelo|length %}
                {% if num_aulas_realizadas == num_aulas_modelo and num_aulas_modelo > 0 %}
                    <div class="d-grid mt-4">
                        <a href="{{ url_for('ctm.arquivar_turma', turma_id=turma.id) }}" class="btn btn-lg btn-success">Concluir Turma</a>
                    </div>
                {% endif %}
            {% endif %}
            
            {% for aula_realizada in aulas_realizadas %}
            <div class="modal fade" id="infoAulaRealizadaModal{{ aula_realizada.id }}" tabindex="-1" aria-labelledby="infoAulaRealizadaModalLabel{{ aula_realizada.id }}" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="infoAulaRealizadaModalLabel{{ aula_realizada.id }}">Detalhes da Aula</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p><strong>Turma:</strong> {{ turma.nome }}</p>
                            <p><strong>Aula:</strong> {{ aula_realizada.aula_modelo.tema }}</p>
                            <p><strong>Data:</strong> {{ aula_realizada.data.strftime('%d/%m/%Y') }}</p>
                            <p><strong>Palavra-Chave:</strong> {{ aula_realizada.chave }}</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="col-md-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Alunos e Presenças</h5>
                    {% if turma.ativa %}
                        <button type="button" class="btn btn-sm btn-info text-white" data-bs-toggle="modal" data-bs-target="#adicionarAlunoModal">Adicionar Aluno</button>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm">
                            <thead>
                                <tr>
                                    <th scope="col" class="text-nowrap">Aluno</th>
                                    {% for aula in aulas_realizadas %}
                                        <th scope="col" class="text-center" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ aula.aula_modelo.tema }}">
                                            {{ aula.data.strftime('%d/%m') }}
                                            <div class="fw-bold">{{ aula.aula_modelo.ordem }}</div>
                                        </th>
                                    {% endfor %}
                                    {% if turma.ativa %}
                                    <th scope="col" class="text-nowrap text-center">Ações</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for aluno in dados_alunos %}
                                <tr>
                                    <td class="text-nowrap">{{ aluno.nome }}</td>
                                    {% for aula in aulas_realizadas %}
                                        <td class="text-center">
                                            <form method="POST" action="{{ url_for('ctm.lancar_presenca_manual', turma_id=turma.id) }}" style="display:inline;">
                                                <input type="hidden" name="membro_id" value="{{ aluno.id }}">
                                                <input type="hidden" name="aula_id" value="{{ aula.id }}">
                                                <button type="submit" class="btn btn-link p-0 m-0">
                                                    {% if aula.id in aluno.presencas %}
                                                        <i class="bi bi-check-circle-fill text-success"></i>
                                                    {% else %}
                                                        <i class="bi bi-x-circle-fill text-danger"></i>
                                                    {% endif %}
                                                </button>
                                            </form>
                                        </td>
                                    {% endfor %}
                                    {% if turma.ativa %}
                                    <td class="text-center">
                                        <form method="POST" action="{{ url_for('ctm.remover_aluno', turma_id=turma.id, membro_id=aluno.id) }}" onsubmit="return confirm('Tem certeza que deseja remover este aluno da turma?');">
                                            <button type="submit" class="btn btn-sm btn-danger">Remover</button>
                                        </form>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            </div>
    </div>
</div>

<div class="modal fade" id="adicionarAlunoModal" tabindex="-1" aria-labelledby="adicionarAlunoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('ctm.adicionar_aluno', turma_id=turma.id) }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="adicionarAlunoModalLabel">Adicionar Aluno à Turma</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Selecione um membro para adicionar à turma:</p>
                    <select class="form-select" name="membro_id" id="membro_id_select2"></select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="submit" class="btn btn-primary">Adicionar</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% for aula_modelo in turma.classe.aulas_modelo %}
<div class="modal fade" id="realizarAulaModal{{ aula_modelo.id }}" tabindex="-1" aria-labelledby="realizarAulaModalLabel{{ aula_modelo.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('ctm.criar_aula_realizada') }}">
                {{ form.hidden_tag() }} 
                <input type="hidden" name="turma_id" value="{{ turma.id }}">
                <input type="hidden" name="aula_modelo_id" value="{{ aula_modelo.id }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="realizarAulaModalLabel{{ aula_modelo.id }}">Realizar Aula: {{ aula_modelo.tema }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Você está criando uma aula realizada para a turma <strong>{{ turma.nome }}</strong>.</p>
                    <div class="mb-3">
                        <label for="data" class="form-label">Data da Aula</label>
                        <input type="date" name="data" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="chave" class="form-label">Palavra-Chave para Confirmação</label>
                        <input type="text" name="chave" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="submit" class="btn btn-primary">Salvar Aula</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

{% for aula in aulas_realizadas %}
    {{ confirm_modal(
        id='confirmDeleteAulaRealizadaModal' ~ aula.id,
        title='Confirmar Exclusão de Aula Realizada',
        body='Tem certeza que deseja deletar a Aula Realizada de ' ~ aula.data.strftime('%d/%m/%Y') ~ ' da Turma ' ~ aula.turma.nome ~ '? Atenção: Isso irá remover todas as presenças associadas e não pode ser desfeito.',
        action_url=url_for('ctm.deletar_aula_realizada', aula_realizada_id=aula.id)
    ) }}
{% endfor %}

{% for aula_modelo in turma.classe.aulas_modelo %}
    {{ confirm_modal(
        id='confirmDeleteAulaModal' ~ aula_modelo.id,
        title='Confirmar Exclusão de Aula Modelo',
        body='Tem certeza que deseja deletar a Aula Modelo ' ~ aula_modelo.tema ~ '? Atenção: Isso não pode ser desfeito e só é possível se não houver aulas realizadas vinculadas.',
        action_url=url_for('ctm.deletar_aula_modelo', aula_id=aula_modelo.id)
    ) }}
{% endfor %}
    
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })
    
    $(document).ready(function() {
        $('#membro_id_select2').select2({
            dropdownParent: $('#adicionarAlunoModal'),
            theme: "bootstrap-5",
            placeholder: 'Pesquisar membro...',
            ajax: {
                url: '{{ url_for('membresia.buscar_membros_ctm', turma_id=turma.id) }}',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        term: params.term
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.items
                    };
                },
                cache: true
            }
        });
    });
</script>
{% endblock %}